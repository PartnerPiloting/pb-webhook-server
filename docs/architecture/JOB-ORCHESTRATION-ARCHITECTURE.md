# Job Orchestration Architecture

## Overview

This document describes the proper service boundaries for job tracking in the PB Webhook Server. The system now enforces a clear separation of responsibilities to prevent duplicate job records and maintain clean architecture.

## Key Principles

1. **Single Source of Truth**: The `jobOrchestrationService` is the ONLY component that should create job tracking records
2. **Clear Service Boundaries**: Routes and controllers should never create job records directly
3. **Consistent Run ID Generation**: Run IDs should only be generated by the orchestration service
4. **Proper Lifecycle Management**: The orchestration service tracks the entire lifecycle of a job

## Service Architecture

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│                 │         │                 │         │                 │
│  API Routes     │  uses   │     Job         │  uses   │ JobTracking &   │
│  and Handlers   │ ──────> │  Orchestration  │ ──────> │ Repositories    │
│                 │         │    Service      │         │                 │
└─────────────────┘         └─────────────────┘         └─────────────────┘
```

## Using the Job Orchestration Service

### Starting a Job

```javascript
// CORRECT - Use orchestration service
const jobInfo = await jobOrchestrationService.startJob({
  jobType: 'post_scoring', 
  clientId: client.id,  // Optional
  initialData: {
    'System Notes': 'Starting post scoring process'
  }
});

// Use the runId provided by the service
const runId = jobInfo.runId;
```

### Checking Job Status

```javascript
// Check if a specific job type is already running
if (jobOrchestrationService.isJobRunning('post_scoring')) {
  // Handle case where job is already running
  const jobInfo = jobOrchestrationService.getRunningJobInfo('post_scoring');
  console.log(`Job already running since ${jobInfo.startTime}`);
}
```

### Completing a Job

```javascript
// Complete a job with final metrics
await jobOrchestrationService.completeJob({
  jobType: 'post_scoring',
  runId: runId,
  finalMetrics: {
    'Total Posts Scored': 150,
    'Success Rate': '98%',
    'System Notes': 'Job completed successfully'
  },
  status: STATUS_VALUES.COMPLETED
});
```

## INCORRECT Patterns to Avoid

❌ **DO NOT** generate run IDs directly using JobTracking.generateRunId()  
❌ **DO NOT** create job records directly using JobTracking.createJob()  
❌ **DO NOT** update job status without going through the orchestration service  

## Preventing Duplicate Records

The orchestration service prevents duplicate records by:

1. Using in-memory tracking of active jobs
2. Properly normalizing run IDs 
3. Enforcing a single entry point for job creation
4. Maintaining clear service boundaries

## Error Handling

If a job encounters an error, complete it with the appropriate error status:

```javascript
await jobOrchestrationService.completeJob({
  jobType: 'post_scoring',
  runId: runId,
  finalMetrics: {
    'System Notes': `Error: ${error.message}`
  },
  status: STATUS_VALUES.FAILED
});
```